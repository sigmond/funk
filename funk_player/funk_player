#!/usr/bin/python
"""                                                                            
Play MIDI file object to message bus

Example:

    funk_player

"""
from __future__ import print_function, division
import sys
import argparse
import mido
import zmq
from mido import MidiFile, Message, tempo2bpm

def parse_args():
    parser = argparse.ArgumentParser(description=__doc__)
    arg = parser.add_argument

    arg('-i', '--data-bus-in',
        dest='data_bus_in',
        default='ipc:///tmp/data_bus_proxy_out',
        help='path to input socket')

    arg('-o', '--data-bus-out',
        dest='data_bus_out',
        default='ipc:///tmp/data_bus_proxy_in',
        help='path to output socket')

    arg('-m', '--print-messages',
        dest='print_messages',
        action='store_true',
        default=False,
        help='Print messages as they are played back')

    arg('-q', '--quiet',
        dest='quiet',
        action='store_true',
        default=False,
        help='print nothing')

    return parser.parse_args()


def connect_subscriber(path):
    context = zmq.Context()
    socket = context.socket(zmq.SUB)
    socket.connect (path)
    return socket

def connect_publisher(path):
    context = zmq.Context()
    socket = context.socket(zmq.PUB)
    socket.connect (path)
    return socket

def subscribe(socket, topic):
    socket.setsockopt(zmq.SUBSCRIBE, topic)

def open_output(port):
    return mido.open_output(port)

def reset_output(output):
    output.reset()

def play_file(midi_file, tick, print_messages):
    playing = True
    print('Playing')
    length = midi_file.length
    print('Song length: {} minutes, {} seconds.'.format(
            int(length / 60),
            int(length % 60)))
    print('Tracks:')
    for i, track in enumerate(midi_file.tracks):
        print('  {:2d}: {!r}'.format(i, track.name.strip()))

    for message in midi_file.play(meta_messages=True):
        try:
            topic = ctrl_socket.recv(flags=NOBLOCK)
            ctrl_msg = ctrl_socket.recv_pyobj(flags=NOBLOCK)
            if handle_ctrl_msg(topic, ctrl_msg) == 'stop':
                playing = False
                return
        except:
            pass
        
        if print_messages:
            print(repr(message))

        if isinstance(message, Message):
            pub_socket.send_string('play', flags=zmq.SNDMORE)
            pub_socket.send_pyobj(message)
        elif message.type == 'set_tempo':
            print('Tempo changed to {:.1f} BPM.'.format(
                tempo2bpm(message.tempo)))

    print()
    playing = False


def track2file(track):
    midi_file = MidiFile(type=1)
    midi_file.tracks.append(track)
    return midi_file


def handle_play_command(msg):
    print('Got play command')
    if msg['type'] == 'track':
        print ('converting to file')
        midi_file = track2file(msg['midi_obj'])
        print('midi_file ' + repr(midi_file))
        print ('calling play')
        play_file(pub_socket, midi_file, msg['tick'], args.print_messages)
    elif msg['type'] == 'file':
        print ('calling play')
        play_file(pub_socket, msg['midi_obj'], msg['tick'], args.print_messages)

    return ''
        
def handle_stop_command(msg):
    print('Got stop command, playing = ' + repr(playing))
    return 'stop'
        
def handle_ctrl_msg(topic, msg):
    print('Got ctrl message')
    print('topic ' + repr(topic) + ' msg ' + repr(msg))
    if topic == 'player':
        if msg['command'] == 'play':
            return handle_play_command(msg)
        elif msg['command'] == 'stop':
            return handle_stop_command(msg)
        else:
            print('Unknown player command ' + repr(msg['command'])
    elif topic == 'all':
        if ctrl_msg['command'] == 'quit':
            print ('Quitting')
            exit(0)
    
    
def main():
    ctrl_socket = connect_subscriber(args.data_bus_in)
    pub_socket = connect_publisher(args.data_bus_out)
    
    subscribe(ctrl_socket, 'all')
    subscribe(ctrl_socket, 'player')
    
    subpoller = zmq.Poller()
    subpoller.register(ctrl_socket, zmq.POLLIN)

    playing = False

    while 1:
        try:
            clientsock = dict(subpoller.poll(None))

            if clientsock:
                if ctrl_socket in clientsock and clientsock[ctrl_socket] == zmq.POLLIN:
                    topic = ctrl_socket.recv()
                    ctrl_msg = ctrl_socket.recv_pyobj()
                    handle_ctrl_msg(topic, ctrl_msg)
        except:
            exit(0)

args = parse_args()

if args.quiet:
    def print(*args):
        pass

main()
